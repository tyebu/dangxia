<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wxc.dangxia.dao.system.IRoleDao">
    <sql id="roleField">
        id,role_name,role_description,createtime,revamptime,status
    </sql>

    <!--java类与数据库字段进行映射-->
    <resultMap id="roleMap" type="com.wxc.dangxia.entity.Role">
        <id property="id" column="id"></id>
        <result property="roleName" column="role_name"></result>
        <result property="roleDescription" column="role_description"></result>
        <result property="createtime" column="createtime"></result>
        <result property="revamptime" column="revamptime"></result>
        <result property="status" column="status"></result>
    </resultMap>
    <!--获得所有的角色-->
    <select id="getRoleAll"  resultMap="roleMap">
        SELECT <include refid="roleField"></include> FROM tbl_role
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
            <if test="roleName != null and roleName!=''">
                AND role_name LIKE CONCAT('%',CONCAT(#{roleName},'%'))
            </if>
        </where>
        <if test="field !=null and field !=''">
            ORDER BY ${field} ${order}
        </if>
    </select>
    <!--获得角色的总个数-->
    <select id="getRoleTotalAll"  resultType="integer">
        SELECT COUNT(*) FROM tbl_role
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
            <if test="roleName != null and roleName!=''">
                AND role_name LIKE CONCAT('%',CONCAT(#{roleName},'%'))
            </if>
        </where>
    </select>
    <!--修改角色状态-->
    <update id="updateRoleStatus" parameterType="integer">
        UPDATE tbl_role SET status = #{status} WHERE id = #{id}
    </update>
    <!--删除角色信息-->
    <delete id="deleteRoleById" parameterType="integer">
        DELETE FROM tbl_role WHERE id = #{id}
    </delete>
    <!--删除员工角色表关于角色的记录-->
    <delete id="deleteEmpRoleByRoleId" parameterType="integer">
        DELETE FROM tbl_emp_role WHERE role_id = #{id}
    </delete>
    <!--删除角色权限表有关角色的记录-->
    <delete id="deleteRolePermissionByRoleId" parameterType="integer">
        DELETE FROM  tbl_role_permission WHERE role_id = #{id}
    </delete>
    <!--添加角色-->
    <insert id="addRole" parameterType="com.wxc.dangxia.entity.Role" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tbl_role (id,role_name,role_description,createtime,revamptime,status) VALUES (NULL,#{roleName},#{roleDescription},NOW(),NOW(),0);
    </insert>
    <!--在角色权限表添加角色权限-->
    <insert id="addRolePermission" parameterType="integer">
        INSERT  INTO tbl_role_permission (role_id,permi_id) VALUES 
        <foreach collection="ids" item="permiId" separator=",">
            (#{id},#{permiId})
        </foreach>
    </insert>
    <!--修改角色信息-->
    <update id="updateRoleById" parameterType="com.aaa.dang.common.entity.Role">
        UPDATE tbl_role SET role_name = #{roleName},role_description=#{roleDescription},revamptime=NOW() WHERE id = #{id}
    </update>
    <!--按角色名查询条数-->
    <select id="isExistRoleName" parameterType="com.aaa.dang.common.entity.Role" resultType="integer">
        SELECT COUNT(role_name) FROM tbl_role WHERE role_name=#{roleName}
        <if test="id !=null and id !=''">
            AND id != #{id}
        </if>
    </select>

    <!--通过用户名获得拥有的角色-->
    <select id="getRolesByempLoginname" resultType="java.util.Map">
        SELECT tbl_role.id,tbl_role.role_name roleName,tbl_role.role_description roleDescription,tbl_role.createtime,tbl_role.revamptime,tbl_role.`status` FROM tbl_employee join tbl_emp_role on tbl_employee.id = tbl_emp_role.emp_id join tbl_role on tbl_emp_role.role_id = tbl_role.id WHERE tbl_employee.emp_loginname=#{userName}
    </select>
</mapper>